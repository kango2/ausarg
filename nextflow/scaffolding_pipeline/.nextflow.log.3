Nov-22 15:34:41.312 [main] DEBUG nextflow.cli.Launcher - $> nextflow /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/scaffold_jigsaw.nf --fasta /g/data/xl04/ka6418/nextflow_testing/testdata/asm.contigs.fasta --PE_1 /g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R1.fastq.gz --PE_2 /g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R2.fastq.gz --outputdir /g/data/xl04/ka6418/nextflow_testing/dedup/dedupp
Nov-22 15:34:41.394 [main] INFO  nextflow.cli.CmdRun - N E X T F L O W  ~  version 23.04.3
Nov-22 15:34:41.411 [main] DEBUG nextflow.plugin.PluginsFacade - Setting up plugin manager > mode=prod; embedded=false; plugins-dir=/home/150/ka6418/.nextflow/plugins; core-plugins: nf-amazon@1.16.2,nf-azure@1.0.1,nf-codecommit@0.1.4,nf-console@1.0.5,nf-ga4gh@1.0.5,nf-google@1.7.3,nf-tower@1.5.12,nf-wave@0.8.4
Nov-22 15:34:41.420 [main] INFO  org.pf4j.DefaultPluginStatusProvider - Enabled plugins: []
Nov-22 15:34:41.421 [main] INFO  org.pf4j.DefaultPluginStatusProvider - Disabled plugins: []
Nov-22 15:34:41.424 [main] INFO  org.pf4j.DefaultPluginManager - PF4J version 3.4.1 in 'deployment' mode
Nov-22 15:34:41.433 [main] INFO  org.pf4j.AbstractPluginManager - No plugins
Nov-22 15:34:41.520 [main] DEBUG nextflow.cli.CmdRun - Applied DSL=2 by global default
Nov-22 15:34:41.533 [main] INFO  nextflow.cli.CmdRun - Launching `/g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/scaffold_jigsaw.nf` [nostalgic_bohr] DSL2 - revision: 61604de50a
Nov-22 15:34:41.535 [main] DEBUG nextflow.plugin.PluginsFacade - Plugins default=[]
Nov-22 15:34:41.535 [main] DEBUG nextflow.plugin.PluginsFacade - Plugins resolved requirement=[]
Nov-22 15:34:41.552 [main] DEBUG nextflow.secret.LocalSecretsProvider - Secrets store: /home/150/ka6418/.nextflow/secrets/store.json
Nov-22 15:34:41.559 [main] DEBUG nextflow.secret.SecretsLoader - Discovered secrets providers: [nextflow.secret.LocalSecretsProvider@21c7208d] - activable => nextflow.secret.LocalSecretsProvider@21c7208d
Nov-22 15:34:41.736 [main] DEBUG nextflow.Session - Session UUID: 31e66612-b4e0-434d-b52e-a26036fb678f
Nov-22 15:34:41.736 [main] DEBUG nextflow.Session - Run name: nostalgic_bohr
Nov-22 15:34:41.742 [main] DEBUG nextflow.Session - Executor pool size: 48
Nov-22 15:34:41.756 [main] DEBUG nextflow.util.ThreadPoolBuilder - Creating thread pool 'FileTransfer' minSize=10; maxSize=144; workQueue=LinkedBlockingQueue[10000]; allowCoreThreadTimeout=false
Nov-22 15:34:41.818 [main] DEBUG nextflow.cli.CmdRun - 
  Version: 23.04.3 build 5876
  Created: 18-09-2023 03:27 UTC (13:27 GMT+10:00)
  System: Linux 4.18.0-477.27.1.el8.nci.x86_64
  Runtime: Groovy 3.0.16 on OpenJDK 64-Bit Server VM 17.0.2+8-86
  Encoding: UTF-8 (UTF-8)
  Process: 1844709@gadi-login-05.gadi.nci.org.au [10.6.152.5]
  CPUs: 48 - Mem: 4 GB (653.4 MB) - Swap: 16 GB (15.2 GB)
Nov-22 15:34:41.852 [main] DEBUG nextflow.Session - Work-dir: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work [lustre]
Nov-22 15:34:41.852 [main] DEBUG nextflow.Session - Script base path does not exist or is not a directory: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/bin
Nov-22 15:34:41.886 [main] DEBUG nextflow.executor.ExecutorFactory - Extension executors providers=[GoogleLifeSciencesExecutor, AwsBatchExecutor, GoogleBatchExecutor]
Nov-22 15:34:41.897 [main] DEBUG nextflow.Session - Observer factory: DefaultObserverFactory
Nov-22 15:34:41.899 [main] DEBUG nextflow.Session - Observer factory: TowerFactory
Nov-22 15:34:41.922 [main] DEBUG nextflow.cache.CacheFactory - Using Nextflow cache factory: nextflow.cache.DefaultCacheFactory
Nov-22 15:34:41.931 [main] DEBUG nextflow.util.CustomThreadPool - Creating default thread pool > poolSize: 49; maxThreads: 1000
Nov-22 15:34:42.076 [main] DEBUG nextflow.Session - Session start
Nov-22 15:34:42.626 [main] DEBUG nextflow.script.ScriptRunner - > Launching execution
Nov-22 15:34:42.703 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: pbspro
Nov-22 15:34:42.704 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'pbspro'
Nov-22 15:34:42.711 [main] DEBUG nextflow.executor.Executor - [warm up] executor > pbspro
Nov-22 15:34:42.715 [main] DEBUG n.processor.TaskPollingMonitor - Creating task monitor for executor 'pbspro' > capacity: 100; pollInterval: 5s; dumpInterval: 5m 
Nov-22 15:34:42.718 [main] DEBUG n.executor.AbstractGridExecutor - Creating executor 'pbspro' > queue-stat-interval: 1m
Nov-22 15:34:42.800 [main] DEBUG nextflow.Session - Workflow process names [dsl2]: arima_mapping
Nov-22 15:34:42.801 [main] DEBUG nextflow.Session - Igniting dataflow network (1)
Nov-22 15:34:42.801 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > arima_mapping
Nov-22 15:34:42.802 [main] DEBUG nextflow.script.ScriptRunner - > Awaiting termination 
Nov-22 15:34:42.802 [main] DEBUG nextflow.Session - Session await
Nov-22 15:34:42.986 [Task submitter] WARN  nextflow.executor.PbsProExecutor - cpus and memory directives are ignored when clusterOptions contains -l option
tip: clusterOptions = { "-l ncpus=${task.cpus},mem=${task.memory.toGiga()}G..." }
Nov-22 15:34:43.148 [Task submitter] DEBUG nextflow.executor.GridTaskHandler - [PBSPRO] submitted process arima_mapping > jobId: 102118149.gadi-pbs; workDir: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/b8/d414dabac3bff3d5cd0eb0e5f0fc3e
Nov-22 15:34:43.149 [Task submitter] INFO  nextflow.Session - [b8/d414da] Submitted process > arima_mapping
Nov-22 15:36:52.742 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[jobId: 102118149.gadi-pbs; id: 1; name: arima_mapping; status: COMPLETED; exit: 1; error: -; workDir: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/b8/d414dabac3bff3d5cd0eb0e5f0fc3e started: 1700631312731; exited: 2023-11-22T05:36:47Z; ]
Nov-22 15:36:52.752 [Task monitor] DEBUG nextflow.processor.TaskProcessor - Handling unexpected condition for
  task: name=arima_mapping; work-dir=/g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/b8/d414dabac3bff3d5cd0eb0e5f0fc3e
  error [nextflow.exception.ProcessFailedException]: Process `arima_mapping` terminated with an error exit status (1)
Nov-22 15:36:52.806 [Task monitor] ERROR nextflow.processor.TaskProcessor - Error executing process > 'arima_mapping'

Caused by:
  Process `arima_mapping` terminated with an error exit status (1)

Command executed:

  module load samtools parallel picard bwa
  
  
  REF=/g/data/xl04/ka6418/nextflow_testing/testdata/asm.contigs.fasta
  R1=/g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R1.fastq.gz
  R2=/g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R2.fastq.gz
  output=/g/data/xl04/ka6418/nextflow_testing/dedup/dedupp
  
  export JAVA_HOME=/apps/java/jdk-17.0.2/bin/java
  label=$(basename ${REF} .fasta)
  WORK_DIR=${PBS_JOBFS}
  
  cp $REF $WORK_DIR
  cd $WORK_DIR
  
  
  mkdir fastq
  ln -s ${R1} fastq/${label}_R1.fastq.gz
  ln -s ${R2} fastq/${label}_R2.fastq.gz
  
  IN_DIR=fastq
  
  
  GENOME_BASENAME=$(basename "$REF")
  REF=$WORK_DIR/$GENOME_BASENAME
  SRA=$label
  LABEL=$label
  PREFIX=$GENOME_BASENAME
  FAIDX="${GENOME_BASENAME}.fai"
  RAW_DIR="$WORK_DIR/raw"
  FILT_DIR="$WORK_DIR/filt"
  TMP_DIR="$WORK_DIR/temp"
  PAIR_DIR="$WORK_DIR/pair"
  REP_DIR="$WORK_DIR/dedup"
  MERGE_DIR="$WORK_DIR/merge"
  REP_LABEL="${LABEL}_rep1"
  FILTER="/g/data/xl04/ka6418/arima/mapping_pipeline/filter_five_end.pl"
  COMBINER="/g/data/xl04/ka6418/arima/mapping_pipeline/two_read_bam_combiner.pl"
  STATS="/g/data/xl04/ka6418/arima/mapping_pipeline/get_stats.pl"
  
  MAPQ_FILTER=10
  CPU=${PBS_NCPUS}
  
  echo "### Step 0: Check output directories' existence & create them as needed"
  [ -d $RAW_DIR ] || mkdir -p $RAW_DIR
  [ -d $FILT_DIR ] || mkdir -p $FILT_DIR
  [ -d $TMP_DIR ] || mkdir -p $TMP_DIR
  [ -d $PAIR_DIR ] || mkdir -p $PAIR_DIR
  [ -d $REP_DIR ] || mkdir -p $REP_DIR
  [ -d $MERGE_DIR ] || mkdir -p $MERGE_DIR
  
  
  if [[ -f "$REF.amb" && -f "$REF.ann" && -f "$REF.bwt" && -f "$REF.pac" && -f "$REF.sa" ]]; then
  echo "BWA index exists"
  else
      echo "BWA index does not exist, creating index..."
      bwa index -a bwtsw -p $PREFIX $REF
  fi
  
  if [[ -f "$REF.fai" ]]; then
      echo "Samtools index exists"
  else
      echo "Samtools index does not exist, creating index..."
      samtools faidx $REF
  fi
  
  HALF_CPU=$(($PBS_NCPUS / 2))
  echo $REF 
  echo $GENOME_BASENAME
  
  #Step 1: FASTQ to BAM
  echo -e "${SRA}_R1.fastq.gz\n${SRA}_R2.fastq.gz" | parallel -j 2 --eta     "bwa mem -t $HALF_CPU $REF $IN_DIR/{} | samtools view -@ $HALF_CPU -Sb - > $RAW_DIR/{/.}.bam"
  
  # Ensure the bwa mem processes have completed before moving on
  wait
  
  # Step 2: Filter 5' end
  echo -e "${SRA}_R1.fastq.bam\n${SRA}_R2.fastq.bam" | parallel -j 2 --eta     "samtools view -h $RAW_DIR/{} | perl $FILTER | samtools view -Sb - > $FILT_DIR/{}"
  
  #echo "### Step 3A: Pair reads & mapping quality filter"
  perl $COMBINER $FILT_DIR/${SRA}_R1.fastq.bam $FILT_DIR/${SRA}_R2.fastq.bam samtools $MAPQ_FILTER | samtools view -bS -t $FAIDX - | samtools sort -@ $CPU -o $TMP_DIR/$SRA.bam -
  
  #echo "### Step 3.B: Add read group"
  java -jar /g/data/if89/apps/picard/2.27.4/picard.jar AddOrReplaceReadGroups INPUT=$TMP_DIR/$SRA.bam OUTPUT=$PAIR_DIR/$SRA.bam ID=$SRA LB=$SRA SM=$LABEL PL=ILLUMINA PU=none
  
  #echo "### Step 4: Mark duplicates"
  java -jar /g/data/if89/apps/picard/2.27.4/picard.jar -Xmx8g MarkDuplicates INPUT=$PAIR_DIR/$SRA.bam OUTPUT=$REP_DIR/$REP_LABEL.bam METRICS_FILE=$REP_DIR/metrics.$REP_LABEL.txt TMP_DIR=$TMP_DIR ASSUME_SORTED=TRUE VALIDATION_STRINGENCY=LENIENT REMOVE_DUPLICATES=TRUE
  
  samtools index $REP_DIR/$REP_LABEL.bam
  
  cd dedup 
  cp ${label}_rep1.bam ${label}_ArimaHiC.bam 
  cp ${label}_rep1.bam.bai ${label}_ArimaHiC.bam.bai
  cp ${label}_ArimaHiC.bam ${output}
  cp ${label}_ArimaHiC.bam.bai ${output}

Command exit status:
  1

Command output:
  ### Step 0: Check output directories' existence & create them as needed
  BWA index does not exist, creating index...
  Samtools index does not exist, creating index...
  /jobfs/102118149.gadi-pbs/asm.contigs.fasta
  asm.contigs.fasta

Command error:
  [32m    ReplaceSamHeader                             [31m[36mReplaces the SAMFileHeader in a SAM/BAM/CRAM file.  [0m
  [32m    RevertOriginalBaseQualitiesAndAddMateCigar   [31m[36mReverts the original base qualities and adds the mate cigar tag to read-group files[0m
  [32m    RevertSam                                    [31m[36mReverts SAM/BAM/CRAM files to a previous state.  [0m
  [32m    SamFormatConverter                           [31m[36mConvert a BAM file to a SAM file, or a SAM to a BAM[0m
  [32m    SamToFastq                                   [31m[36mConverts a SAM/BAM/CRAM file to FASTQ.[0m
  [32m    SamToFastqWithTags                           [31m[36mConverts a SAM or BAM file to FASTQ alongside FASTQs created from tags.[0m
  [32m    SetNmAndUqTags                               [31m[36mDEPRECATED: Use SetNmMdAndUqTags instead.[0m
  [32m    SetNmMdAndUqTags                             [31m[36mFixes the NM, MD, and UQ tags in a SAM/BAM/CRAM file [0m
  [32m    SimpleMarkDuplicatesWithMateCigar            [31m**EXPERIMENTAL - USE AT YOUR OWN RISK** [36mExamines aligned records in the supplied SAM or BAM file to locate duplicate molecules.[0m
  [32m    SortSam                                      [31m[36mSorts a SAM, BAM or CRAM file.  [0m
  [32m    SplitSamByLibrary                            [31m[36mSplits a SAM/BAM/CRAM file into individual files by library[0m
  [32m    SplitSamByNumberOfReads                      [31m[36mSplits a SAM/BAM/CRAM file to multiple files.[0m
  [32m    UmiAwareMarkDuplicatesWithMateCigar          [31m**EXPERIMENTAL - USE AT YOUR OWN RISK** [36mIdentifies duplicate reads using information from read positions and UMIs. [0m
  
  [37m--------------------------------------------------------------------------------------
  [0m[31mReference:                                       Tools that analyze and manipulate FASTA format references[0m
  [32m    BaitDesigner                                 [31m[36mDesigns oligonucleotide baits for hybrid selection reactions.[0m
  [32m    CreateSequenceDictionary                     [31m[36mCreates a sequence dictionary for a reference sequence.  [0m
  [32m    ExtractSequences                             [31m[36mSubsets intervals from a reference sequence to a new FASTA file.[0m
  [32m    NonNFastaSize                                [31m[36mCounts the number of non-N bases in a fasta file.[0m
  [32m    NormalizeFasta                               [31m[36mNormalizes lines of sequence in a FASTA file to be of the same length.[0m
  [32m    ScatterIntervalsByNs                         [31m[36mWrites an interval list created by splitting a reference at Ns.[0m
  
  [37m--------------------------------------------------------------------------------------
  [0m[31mVariant Evaluation and Refinement:               Tools that evaluate and refine variant calls, e.g. with annotations not offered by the engine[0m
  [32m    FindMendelianViolations                      [31m[36mFinds mendelian violations of all types within a VCF[0m
  [32m    GenotypeConcordance                          [31m[36mCalculates the concordance between genotype data of one sample in each of two VCFs - truth (or reference) vs. calls.[0m
  
  [37m--------------------------------------------------------------------------------------
  [0m[31mVariant Filtering:                               Tools that filter variants by annotating the FILTER column[0m
  [32m    FilterVcf                                    [31m[36mHard filters a VCF.[0m
  
  [37m--------------------------------------------------------------------------------------
  [0m[31mVariant Manipulation:                            Tools that manipulate variant call format (VCF) data[0m
  [32m    FixVcfHeader                                 [31m[36mReplaces or fixes a VCF header.[0m
  [32m    GatherVcfs                                   [31m[36mGathers multiple VCF files from a scatter operation into a single VCF file[0m
  [32m    LiftoverVcf                                  [31m[36mLifts over a VCF file from one reference build to another.  [0m
  [32m    MakeSitesOnlyVcf                             [31m[36mCreates a VCF that contains all the site-level information for all records in the input VCF but no genotype information.[0m
  [32m    MakeVcfSampleNameMap                         [31m[36mCreates a TSV from sample name to VCF/GVCF path, with one line per input.[0m
  [32m    MergeVcfs                                    [31m[36mCombines multiple variant files into a single variant file[0m
  [32m    RenameSampleInVcf                            [31m[36mRenames a sample within a VCF or BCF.[0m
  [32m    SortVcf                                      [31m[36mSorts one or more VCF files.  [0m
  [32m    SplitVcfs                                    [31m[36mSplits SNPs and INDELs into separate files.  [0m
  [32m    UpdateVcfSequenceDictionary                  [31m[36mTakes a VCF and a second file that contains a sequence dictionary and updates the VCF with the new sequence dictionary.[0m
  [32m    VcfFormatConverter                           [31m[36mConverts VCF to BCF or BCF to VCF.  [0m
  [32m    VcfToIntervalList                            [31m[36mConverts a VCF or BCF file to a Picard Interval List[0m
  
  [37m--------------------------------------------------------------------------------------
  
  [0m'-Xmx8g' is not a valid command. See PicardCommandLine -h for more information.

Work dir:
  /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/b8/d414dabac3bff3d5cd0eb0e5f0fc3e

Tip: view the complete command output by changing to the process work dir and entering the command `cat .command.out`
Nov-22 15:36:52.811 [Task monitor] DEBUG nextflow.Session - Session aborted -- Cause: Process `arima_mapping` terminated with an error exit status (1)
Nov-22 15:36:52.813 [main] DEBUG nextflow.Session - Session await > all processes finished
Nov-22 15:36:52.827 [main] DEBUG nextflow.Session - Session await > all barriers passed
Nov-22 15:36:52.840 [main] DEBUG nextflow.trace.WorkflowStatsObserver - Workflow completed > WorkflowStats[succeededCount=0; failedCount=1; ignoredCount=0; cachedCount=0; pendingCount=0; submittedCount=0; runningCount=0; retriesCount=0; abortedCount=0; succeedDuration=0ms; failedDuration=1m 40s; cachedDuration=0ms;loadCpus=0; loadMemory=0; peakRunning=1; peakCpus=1; peakMemory=0; ]
Nov-22 15:36:53.051 [main] DEBUG nextflow.cache.CacheDB - Closing CacheDB done
Nov-22 15:36:53.076 [main] DEBUG nextflow.script.ScriptRunner - > Execution complete -- Goodbye
