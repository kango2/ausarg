Nov-22 15:28:02.852 [main] DEBUG nextflow.cli.Launcher - $> nextflow /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/scaffold_jigsaw.nf --fasta /g/data/xl04/ka6418/nextflow_testing/testdata/asm.contigs.fasta --PE_1 /g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R1.fastq.gz --PE_2 /g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R2.fastq.gz --outputdir /g/data/xl04/ka6418/nextflow_testing/dedup/dedupp
Nov-22 15:28:02.938 [main] INFO  nextflow.cli.CmdRun - N E X T F L O W  ~  version 23.04.3
Nov-22 15:28:03.022 [main] DEBUG nextflow.plugin.PluginsFacade - Setting up plugin manager > mode=prod; embedded=false; plugins-dir=/home/150/ka6418/.nextflow/plugins; core-plugins: nf-amazon@1.16.2,nf-azure@1.0.1,nf-codecommit@0.1.4,nf-console@1.0.5,nf-ga4gh@1.0.5,nf-google@1.7.3,nf-tower@1.5.12,nf-wave@0.8.4
Nov-22 15:28:03.035 [main] INFO  org.pf4j.DefaultPluginStatusProvider - Enabled plugins: []
Nov-22 15:28:03.037 [main] INFO  org.pf4j.DefaultPluginStatusProvider - Disabled plugins: []
Nov-22 15:28:03.040 [main] INFO  org.pf4j.DefaultPluginManager - PF4J version 3.4.1 in 'deployment' mode
Nov-22 15:28:03.057 [main] INFO  org.pf4j.AbstractPluginManager - No plugins
Nov-22 15:28:03.183 [main] DEBUG nextflow.cli.CmdRun - Applied DSL=2 by global default
Nov-22 15:28:03.201 [main] INFO  nextflow.cli.CmdRun - Launching `/g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/scaffold_jigsaw.nf` [curious_archimedes] DSL2 - revision: 8ac0509092
Nov-22 15:28:03.202 [main] DEBUG nextflow.plugin.PluginsFacade - Plugins default=[]
Nov-22 15:28:03.202 [main] DEBUG nextflow.plugin.PluginsFacade - Plugins resolved requirement=[]
Nov-22 15:28:03.219 [main] DEBUG nextflow.secret.LocalSecretsProvider - Secrets store: /home/150/ka6418/.nextflow/secrets/store.json
Nov-22 15:28:03.263 [main] DEBUG nextflow.secret.SecretsLoader - Discovered secrets providers: [nextflow.secret.LocalSecretsProvider@4417af13] - activable => nextflow.secret.LocalSecretsProvider@4417af13
Nov-22 15:28:03.346 [main] DEBUG nextflow.Session - Session UUID: 6e9dad88-9707-4d2e-9077-2e18d229c4cc
Nov-22 15:28:03.347 [main] DEBUG nextflow.Session - Run name: curious_archimedes
Nov-22 15:28:03.349 [main] DEBUG nextflow.Session - Executor pool size: 48
Nov-22 15:28:03.360 [main] DEBUG nextflow.util.ThreadPoolBuilder - Creating thread pool 'FileTransfer' minSize=10; maxSize=144; workQueue=LinkedBlockingQueue[10000]; allowCoreThreadTimeout=false
Nov-22 15:28:03.391 [main] DEBUG nextflow.cli.CmdRun - 
  Version: 23.04.3 build 5876
  Created: 18-09-2023 03:27 UTC (13:27 GMT+10:00)
  System: Linux 4.18.0-477.27.1.el8.nci.x86_64
  Runtime: Groovy 3.0.16 on OpenJDK 64-Bit Server VM 17.0.2+8-86
  Encoding: UTF-8 (UTF-8)
  Process: 1695660@gadi-login-05.gadi.nci.org.au [10.6.152.5]
  CPUs: 48 - Mem: 4 GB (1 GB) - Swap: 16 GB (15.2 GB)
Nov-22 15:28:03.421 [main] DEBUG nextflow.Session - Work-dir: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work [lustre]
Nov-22 15:28:03.422 [main] DEBUG nextflow.Session - Script base path does not exist or is not a directory: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/bin
Nov-22 15:28:03.454 [main] DEBUG nextflow.executor.ExecutorFactory - Extension executors providers=[GoogleLifeSciencesExecutor, AwsBatchExecutor, GoogleBatchExecutor]
Nov-22 15:28:03.466 [main] DEBUG nextflow.Session - Observer factory: DefaultObserverFactory
Nov-22 15:28:03.468 [main] DEBUG nextflow.Session - Observer factory: TowerFactory
Nov-22 15:28:03.487 [main] DEBUG nextflow.cache.CacheFactory - Using Nextflow cache factory: nextflow.cache.DefaultCacheFactory
Nov-22 15:28:03.494 [main] DEBUG nextflow.util.CustomThreadPool - Creating default thread pool > poolSize: 49; maxThreads: 1000
Nov-22 15:28:03.644 [main] DEBUG nextflow.Session - Session start
Nov-22 15:28:04.192 [main] DEBUG nextflow.script.ScriptRunner - > Launching execution
Nov-22 15:28:04.250 [main] DEBUG nextflow.executor.ExecutorFactory - << taskConfig executor: pbspro
Nov-22 15:28:04.250 [main] DEBUG nextflow.executor.ExecutorFactory - >> processorType: 'pbspro'
Nov-22 15:28:04.256 [main] DEBUG nextflow.executor.Executor - [warm up] executor > pbspro
Nov-22 15:28:04.260 [main] DEBUG n.processor.TaskPollingMonitor - Creating task monitor for executor 'pbspro' > capacity: 100; pollInterval: 5s; dumpInterval: 5m 
Nov-22 15:28:04.263 [main] DEBUG n.executor.AbstractGridExecutor - Creating executor 'pbspro' > queue-stat-interval: 1m
Nov-22 15:28:04.346 [main] DEBUG nextflow.Session - Workflow process names [dsl2]: arima_mapping
Nov-22 15:28:04.346 [main] DEBUG nextflow.Session - Igniting dataflow network (1)
Nov-22 15:28:04.346 [main] DEBUG nextflow.processor.TaskProcessor - Starting process > arima_mapping
Nov-22 15:28:04.347 [main] DEBUG nextflow.script.ScriptRunner - > Awaiting termination 
Nov-22 15:28:04.347 [main] DEBUG nextflow.Session - Session await
Nov-22 15:28:04.555 [Task submitter] WARN  nextflow.executor.PbsProExecutor - cpus and memory directives are ignored when clusterOptions contains -l option
tip: clusterOptions = { "-l ncpus=${task.cpus},mem=${task.memory.toGiga()}G..." }
Nov-22 15:28:04.715 [Task submitter] DEBUG nextflow.executor.GridTaskHandler - [PBSPRO] submitted process arima_mapping > jobId: 102117699.gadi-pbs; workDir: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/03/6349c341246b89a3b7c6fa0c143b79
Nov-22 15:28:04.716 [Task submitter] INFO  nextflow.Session - [03/6349c3] Submitted process > arima_mapping
Nov-22 15:28:39.277 [Task monitor] DEBUG n.processor.TaskPollingMonitor - Task completed > TaskHandler[jobId: 102117699.gadi-pbs; id: 1; name: arima_mapping; status: COMPLETED; exit: 1; error: -; workDir: /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/03/6349c341246b89a3b7c6fa0c143b79 started: 1700630914276; exited: 2023-11-22T05:28:37Z; ]
Nov-22 15:28:39.285 [Task monitor] DEBUG nextflow.processor.TaskProcessor - Handling unexpected condition for
  task: name=arima_mapping; work-dir=/g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/03/6349c341246b89a3b7c6fa0c143b79
  error [nextflow.exception.ProcessFailedException]: Process `arima_mapping` terminated with an error exit status (1)
Nov-22 15:28:39.316 [Task monitor] ERROR nextflow.processor.TaskProcessor - Error executing process > 'arima_mapping'

Caused by:
  Process `arima_mapping` terminated with an error exit status (1)

Command executed:

  module load samtools parallel picard bwa
  
  
  REF=/g/data/xl04/ka6418/nextflow_testing/testdata/asm.contigs.fasta
  R1=/g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R1.fastq.gz
  R2=/g/data/xl04/ka6418/nextflow_testing/testdata/fastq/HIC_R2.fastq.gz
  output=/g/data/xl04/ka6418/nextflow_testing/dedup/dedupp
  
  export JAVA_HOME=/apps/java/jdk-17.0.2/bin/java
  label=$(basename ${REF} .fasta)
  WORK_DIR=${PBS_JOBFS}
  
  cp $REF $WORK_DIR
  cd $WORK_DIR
  
  
  mkdir fastq
  ln -s ${R1} fastq/${label}_R1.fastq.gz
  ln -s ${R2} fastq/${label}_R2.fastq.gz
  
  IN_DIR=fastq
  
  
  GENOME_BASENAME=$(basename "$REF")
  REF=$WORK_DIR/$GENOME_BASENAME
  SRA=$label
  LABEL=$label
  PREFIX=$GENOME_BASENAME
  FAIDX="${GENOME_BASENAME}.fai"
  RAW_DIR="$WORK_DIR/raw"
  FILT_DIR="$WORK_DIR/filt"
  TMP_DIR="$WORK_DIR/temp"
  PAIR_DIR="$WORK_DIR/pair"
  REP_DIR="$WORK_DIR/dedup"
  REP_LABEL="${LABEL}_rep1"
  FILTER="/g/data/xl04/ka6418/arima/mapping_pipeline/filter_five_end.pl"
  COMBINER="/g/data/xl04/ka6418/arima/mapping_pipeline/two_read_bam_combiner.pl"
  STATS="/g/data/xl04/ka6418/arima/mapping_pipeline/get_stats.pl"
  
  MAPQ_FILTER=10
  CPU=${PBS_NCPUS}
  
  echo "### Step 0: Check output directories' existence & create them as needed"
  [ -d $RAW_DIR ] || mkdir -p $RAW_DIR
  [ -d $FILT_DIR ] || mkdir -p $FILT_DIR
  [ -d $TMP_DIR ] || mkdir -p $TMP_DIR
  [ -d $PAIR_DIR ] || mkdir -p $PAIR_DIR
  [ -d $REP_DIR ] || mkdir -p $REP_DIR
  [ -d $MERGE_DIR ] || mkdir -p $MERGE_DIR
  
  
  if [[ -f "$REF.amb" && -f "$REF.ann" && -f "$REF.bwt" && -f "$REF.pac" && -f "$REF.sa" ]]; then
  echo "BWA index exists"
  else
      echo "BWA index does not exist, creating index..."
      bwa index -a bwtsw -p $PREFIX $REF
  fi
  
  if [[ -f "$REF.fai" ]]; then
      echo "Samtools index exists"
  else
      echo "Samtools index does not exist, creating index..."
      samtools faidx $REF
  fi
  
  HALF_CPU=$(($PBS_NCPUS / 2))
  echo $REF 
  echo $GENOME_BASENAME
  
  #Step 1: FASTQ to BAM
  echo -e "${SRA}_R1.fastq.gz\n${SRA}_R2.fastq.gz" | parallel -j 2 --eta     "bwa mem -t $HALF_CPU $REF $IN_DIR/{} | samtools view -@ $HALF_CPU -Sb - > $RAW_DIR/{/.}.bam"
  
  # Ensure the bwa mem processes have completed before moving on
  wait
  
  # Step 2: Filter 5' end
  echo -e "${SRA}_R1.fastq.bam\n${SRA}_R2.fastq.bam" | parallel -j 2 --eta     "samtools view -h $RAW_DIR/{} | perl $FILTER | samtools view -Sb - > $FILT_DIR/{}"
  
  #echo "### Step 3A: Pair reads & mapping quality filter"
  perl $COMBINER $FILT_DIR/${SRA}_R1.fastq.bam $FILT_DIR/${SRA}_R2.fastq.bam samtools $MAPQ_FILTER | samtools view -bS -t $FAIDX - | samtools sort -@ $CPU -o $TMP_DIR/$SRA.bam -
  
  #echo "### Step 3.B: Add read group"
  picard AddOrReplaceReadGroups INPUT=$TMP_DIR/$SRA.bam OUTPUT=$PAIR_DIR/$SRA.bam ID=$SRA LB=$SRA SM=$LABEL PL=ILLUMINA PU=none
  
  #echo "### Step 4: Mark duplicates"
  picard -Xmx8g MarkDuplicates INPUT=$PAIR_DIR/$SRA.bam OUTPUT=$REP_DIR/$REP_LABEL.bam METRICS_FILE=$REP_DIR/metrics.$REP_LABEL.txt TMP_DIR=$TMP_DIR ASSUME_SORTED=TRUE VALIDATION_STRINGENCY=LENIENT REMOVE_DUPLICATES=TRUE
  
  samtools index $REP_DIR/$REP_LABEL.bam
  
  cd dedup 
  cp ${label}_rep1.bam ${label}_ArimaHiC.bam 
  cp ${label}_rep1.bam.bai ${label}_ArimaHiC.bam.bai
  cp ${label}_ArimaHiC.bam ${output}
  cp ${label}_ArimaHiC.bam.bai ${output}

Command exit status:
  1

Command output:
  ### Step 0: Check output directories' existence & create them as needed

Command error:
  .command.sh: line 50: MERGE_DIR: unbound variable

Work dir:
  /g/data/xl04/ka6418/github/ausarg/nextflow/scaffolding_pipeline/work/03/6349c341246b89a3b7c6fa0c143b79

Tip: when you have fixed the problem you can continue the execution adding the option `-resume` to the run command line
Nov-22 15:28:39.322 [Task monitor] DEBUG nextflow.Session - Session aborted -- Cause: Process `arima_mapping` terminated with an error exit status (1)
Nov-22 15:28:39.324 [main] DEBUG nextflow.Session - Session await > all processes finished
Nov-22 15:28:39.336 [main] DEBUG nextflow.Session - Session await > all barriers passed
Nov-22 15:28:39.356 [main] DEBUG nextflow.trace.WorkflowStatsObserver - Workflow completed > WorkflowStats[succeededCount=0; failedCount=1; ignoredCount=0; cachedCount=0; pendingCount=0; submittedCount=0; runningCount=0; retriesCount=0; abortedCount=0; succeedDuration=0ms; failedDuration=5s; cachedDuration=0ms;loadCpus=0; loadMemory=0; peakRunning=1; peakCpus=1; peakMemory=0; ]
Nov-22 15:28:39.643 [main] DEBUG nextflow.cache.CacheDB - Closing CacheDB done
Nov-22 15:28:39.663 [main] DEBUG nextflow.script.ScriptRunner - > Execution complete -- Goodbye
